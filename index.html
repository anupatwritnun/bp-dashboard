<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏™‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏à üê†</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <!-- LIFF SDK (correct version) -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

    <style>
        :root { font-family: "Inter", sans-serif; }
        .bento-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        @media print {
            .no-print { display: none !important; }
            .chart-container { height: 450px !important; }
        }
    </style>
</head>

<body class="bg-gray-50 p-4 sm:p-8">
<div class="max-w-6xl mx-auto">

    <h1 class="text-3xl font-extrabold text-center mb-6">‡∏™‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏à üê†</h1>

    <!-- FILTER PANEL -->
    <div class="bento-card mb-6 no-print">
        <h2 class="text-lg font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>

        <div class="grid sm:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input id="startDate" type="date"
                    class="w-full p-1.5 border rounded-md text-sm" />
            </div>
            <div>
                <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input id="endDate" type="date"
                    class="w-full p-1.5 border rounded-md text-sm" />
            </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-4">
            <button data-filter="this-month" class="quick-filter-btn px-3 py-1 text-xs border rounded-full">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button data-filter="last-3-months" class="quick-filter-btn px-3 py-1 text-xs border rounded-full">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</button>
            <button data-filter="this-year" class="quick-filter-btn px-3 py-1 text-xs border rounded-full">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
            <button data-filter="all-time" class="quick-filter-btn px-3 py-1 text-xs border rounded-full bg-blue-500 text-white">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô</button>
        </div>

        <button id="print-button" class="px-4 py-2 bg-indigo-600 text-white rounded-md">
            ‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF
        </button>
    </div>

    <!-- AVERAGE CARDS -->
    <div id="average-bento" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10"></div>

    <!-- CHART -->
    <div class="bento-card mb-10">
        <h2 class="text-xl font-semibold mb-4">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ä‡∏µ‡∏û‡∏à‡∏£</h2>
        <div class="chart-container" style="height:350px">
            <canvas id="bpLineChart"></canvas>
        </div>
    </div>

    <!-- TABLE -->
    <div class="bento-card">
        <h2 class="text-xl font-semibold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>

        <div class="overflow-x-auto">
            <table class="w-full text-sm record-table">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th class="text-left">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th class="text-left">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô</th>
                        <th class="text-left">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</th>
                        <th class="text-left">‡∏ä‡∏µ‡∏û‡∏à‡∏£</th>
                    </tr>
                </thead>
                <tbody id="bp-table-body"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
/* ================================
   GLOBAL STATE
================================ */
let allBpRecords = [];
let filteredBpRecords = [];
let bpChartInstance = null;

/* ================================
   LIFF INITIALIZATION
================================ */
async function initLIFF() {
    try {
        await liff.init({ liffId: "2008641952-nWd4qpk6" });

        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        const profile = await liff.getProfile();
        const userId = profile.userId;

        console.log("LINE UserID:", userId);

        await loadBpData(userId);
        setupFilters();

    } catch (err) {
        console.error("LIFF error:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF");
    }
}

/* ================================
   LOAD BP DATA FROM N8N
================================ */
async function loadBpData(userId) {
    try {
        const res = await fetch(
            "https://n8n.srv1159869.hstgr.cloud/webhook/bp-dashboard",
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ userId })
            }
        );

        const data = await res.json();

        allBpRecords = data.map(r => ({
            date: r.date,
            time: r.period ?? r.time ?? "-",
            systolic: r.systolic ? r.systolic : null,
            diastolic: r.diastolic ? r.diastolic : null,
            pulse: r.pulse ? r.pulse : null
        }));

    } catch (err) {
        console.error("Fetch error:", err);
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å server ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
}

/* ================================
   HELPERS
================================ */
const TIME_ORDER = { "‡πÄ‡∏ä‡πâ‡∏≤": 1, "‡∏ö‡πà‡∏≤‡∏¢": 2, "‡πÄ‡∏¢‡πá‡∏ô": 3, "‡∏î‡∏∂‡∏Å": 4, "-": 99 };

function formatThai(d) {
    return new Date(d).toLocaleDateString("th-TH", {
        year: "numeric", month: "short", day: "numeric"
    });
}

const validVals = arr => arr.filter(v => v !== null);

/* ================================
   RENDER AVERAGES
================================ */
function renderAverages() {
    const C = document.getElementById("average-bento");

    if (!filteredBpRecords.length) {
        C.innerHTML = `<div class="col-span-full text-center text-gray-500 py-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
    }

    const sysArr = validVals(filteredBpRecords.map(r => r.systolic));
    const diaArr = validVals(filteredBpRecords.map(r => r.diastolic));
    const pulArr = validVals(filteredBpRecords.map(r => r.pulse));

    const avg = arr => (arr.reduce((a,b)=>a+b,0) / arr.length).toFixed(0);

    const cards = [
        {
            title: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (Systolic)",
            value: avg(sysArr),
            unit: "‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó",
            range: `${Math.min(...sysArr)} - ${Math.max(...sysArr)}`
        },
        {
            title: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (Diastolic)",
            value: avg(diaArr),
            unit: "‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó",
            range: `${Math.min(...diaArr)} - ${Math.max(...diaArr)}`
        },
        {
            title: "‡∏ä‡∏µ‡∏û‡∏à‡∏£ (Pulse)",
            value: avg(pulArr),
            unit: "‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ",
            range: `${Math.min(...pulArr)} - ${Math.max(...pulArr)}`
        },
        { 
            title: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î",
            value: filteredBpRecords.length,
            unit: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
            range: ""
        }
    ];

    C.innerHTML = cards.map(card => `
        <div class="bento-card">
            <p class="text-sm text-gray-500">${card.title}</p>
            <p class="text-3xl font-bold">${card.value}</p>
            <p class="text-xs text-gray-500">${card.unit}</p>
            <p class="text-xs text-gray-400 mt-1">${card.range}</p>
        </div>
    `).join("");
}

/* ================================
   RENDER CHART
================================ */
function renderChart() {
    const ctx = document.getElementById("bpLineChart").getContext("2d");

    if (bpChartInstance) bpChartInstance.destroy();

    if (!filteredBpRecords.length) {
        bpChartInstance = new Chart(ctx, { type: "line", data: {} });
        return;
    }

    const grouped = {};
    filteredBpRecords.forEach(r => {
        if (!grouped[r.date]) grouped[r.date] = [];
        grouped[r.date].push(r);
    });

    const dates = Object.keys(grouped).sort();
    const labels = dates.map(formatThai);

    const avgValid = (arr, key) => {
        const vals = arr.map(v => v[key]).filter(v => v !== null);
        return vals.length ? (vals.reduce((a,b)=>a+b,0) / vals.length) : null;
    };

    const sys = dates.map(d => avgValid(grouped[d], "systolic"));
    const dia = dates.map(d => avgValid(grouped[d], "diastolic"));
    const pul = dates.map(d => avgValid(grouped[d], "pulse"));

    bpChartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [
                {
                    label: "‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (SYS)",
                    data: sys,
                    borderColor: "#ef4444",
                    backgroundColor: "rgba(239,68,68,0.12)",
                    pointBackgroundColor: "#ef4444",
                    borderWidth: 3,
                    pointRadius: 6,
                    tension: 0.35,
                    fill: true
                },
                {
                    label: "‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (DIA)",
                    data: dia,
                    borderColor: "#3b82f6",
                    backgroundColor: "rgba(59,130,246,0.12)",
                    pointBackgroundColor: "#3b82f6",
                    borderWidth: 3,
                    pointRadius: 6,
                    tension: 0.35,
                    fill: true
                },
                {
                    label: "‡∏ä‡∏µ‡∏û‡∏à‡∏£ (Pulse)",
                    data: pul,
                    borderColor: "#10b981",
                    backgroundColor: "rgba(16,185,129,0.12)",
                    pointBackgroundColor: "#10b981",
                    borderWidth: 3,
                    pointRadius: 6,
                    tension: 0.35,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

/* ================================
   RENDER TABLE
================================ */
function renderTable() {
    const TB = document.getElementById("bp-table-body");

    if (!filteredBpRecords.length) {
        TB.innerHTML = `<tr><td colspan="5" class="text-center py-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
    }

    const sorted = [...filteredBpRecords].sort((a,b)=>{
        const d1 = new Date(a.date), d2 = new Date(b.date);
        if (d1 - d2 !== 0) return d1 - d2;
        return TIME_ORDER[a.time] - TIME_ORDER[b.time];
    });

    TB.innerHTML = sorted.map(r => `
        <tr class="border-b hover:bg-gray-100">
            <td>${formatThai(r.date)}</td>
            <td>${r.time}</td>
            <td>${r.systolic ?? "-"}</td>
            <td>${r.diastolic ?? "-"}</td>
            <td>${r.pulse ?? "-"}</td>
        </tr>
    `).join("");
}

/* ================================
   FILTER + INIT
================================ */
function setupFilters() {
    const s = document.getElementById("startDate");
    const e = document.getElementById("endDate");

    document.getElementById("print-button").onclick = () => window.print();

    const btns = document.querySelectorAll(".quick-filter-btn");

    function apply(f) {
        const now = new Date();
        let start;

        if (f === "this-month") start = new Date(now.getFullYear(), now.getMonth(), 1);
        else if (f === "last-3-months") start = new Date(now.getFullYear(), now.getMonth()-3, now.getDate());
        else if (f === "this-year") start = new Date(now.getFullYear(), 0, 1);
        else start = new Date("2000-01-01");

        s.value = f === "all-time" ? "" : start.toISOString().split("T")[0];
        e.value = now.toISOString().split("T")[0];

        updateDashboard();
    }

    btns.forEach(b => b.onclick = () => apply(b.dataset.filter));

    updateDashboard();
}

function updateDashboard() {
    const s = document.getElementById("startDate").value;
    const e = document.getElementById("endDate").value;

    const start = s ? new Date(s) : new Date("2000-01-01");
    const end = e ? new Date(e + "T23:59") : new Date();

    filteredBpRecords = allBpRecords.filter(r => {
        const d = new Date(r.date);
        return d >= start && d <= end;
    });

    renderAverages();
    renderChart();
    renderTable();
}

/* ================================
   START APP
================================ */
window.onload = async () => {
    await initLIFF();
};
</script>

</body>
</html>
