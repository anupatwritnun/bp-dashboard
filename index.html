<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏à üê†</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        .bento-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                        0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease-in-out;
        }
        .bento-card:hover {
            transform: translateY(-2px);
        }
        .chart-container { height: 350px; }
        @media print {
            .no-print { display: none !important; }
            .bento-card { box-shadow: none; border: 1px solid #ccc; }
            .max-w-6xl { max-width: 100%; }
            .chart-container { height: 450px; }
            .record-table thead { display: table-header-group; }
        }
    </style>
</head>

<body class="bg-gray-50 p-4 sm:p-8">

<div class="max-w-6xl mx-auto">

    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-8 text-center">
        ‡∏™‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏à üê†
    </h1>

    <!-- Filter UI -->
    <div class="bento-card p-6 md:p-8 mb-6 no-print">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>

        <div class="flex flex-col lg:flex-row lg:items-end gap-4">

            <div class="flex-grow flex flex-col sm:flex-row gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
                    <input type="date" id="startDate"
                        class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm p-1.5">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                    <input type="date" id="endDate"
                        class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm p-1.5">
                </div>
            </div>

            <div class="flex flex-wrap gap-2">
                <button data-filter="this-month" class="quick-filter-btn px-3 py-1.5 text-xs rounded-full border bg-white">
                    ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                </button>
                <button data-filter="last-3-months" class="quick-filter-btn px-3 py-1.5 text-xs rounded-full border bg-white">
                    3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
                </button>
                <button data-filter="this-year" class="quick-filter-btn px-3 py-1.5 text-xs rounded-full border bg-white">
                    ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
                </button>
                <button data-filter="all-time"
                    class="quick-filter-btn px-3 py-1.5 text-xs rounded-full border bg-blue-500 text-white">
                    ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô
                </button>
            </div>
        </div>

        <div class="mt-4 flex justify-end">
            <button id="print-button"
                class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white hover:bg-indigo-700">
                ‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF
            </button>
        </div>
    </div>

    <!-- Averages -->
    <div id="average-bento"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10"></div>

    <!-- Chart -->
    <div class="bento-card p-6 md:p-8 mb-10">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ä‡∏µ‡∏û‡∏à‡∏£</h2>
        <div class="chart-container">
            <canvas id="bpLineChart"></canvas>
        </div>
    </div>

    <!-- Table -->
    <div class="bento-card p-4 sm:p-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
        <div class="overflow-x-auto">
            <table class="w-full record-table text-sm">
                <thead>
                    <tr class="border-b">
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô</th>
                        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</th>
                        <th>‡∏ä‡∏µ‡∏û‡∏à‡∏£</th>
                    </tr>
                </thead>
                <tbody id="bp-table-body"></tbody>
            </table>
        </div>
    </div>

</div>

<script>

/* ======================================================
   1) READ TOKEN + FETCH REAL BP DATA FROM N8N
====================================================== */

const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get("token");

let allBpRecords = [];
let filteredBpRecords = [];
let bpChartInstance = null;

async function loadBpData() {
    if (!token) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        return;
    }

    try {
        const res = await fetch(
            `https://n8n.srv1159869.hstgr.cloud/webhook/bp-dashboard?token=${token}`
        );

        const data = await res.json();

        if (!Array.isArray(data)) {
            alert("token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á / ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å LINE ‡πÉ‡∏´‡∏°‡πà");
            return;
        }

        allBpRecords = data;

    } catch (err) {
        console.error(err);
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    }
}

/* ======================================================
   2) BP COLOR & UTILITY FUNCTIONS
====================================================== */

const BP_COLOR_MAP = {
    NORMAL:   { tailwind: "text-green-700", point: "rgba(5,150,105,0.1)", border: "#059669" },
    ELEVATED: { tailwind: "text-yellow-700", point: "#facc15", border: "#facc15" },
    STAGE_1:  { tailwind: "text-orange-700", point: "#f97316", border: "#f97316" },
    STAGE_2:  { tailwind: "text-red-600", point: "#ea580c", border: "#ea580c" },
    CRISIS:   { tailwind: "text-red-800", point: "#dc2626", border: "#dc2626" }
};

function getBpCategory(sys, dia) {
    if (sys > 180 || dia > 120) return BP_COLOR_MAP.CRISIS;
    if (sys >= 140 || dia >= 90) return BP_COLOR_MAP.STAGE_2;
    if (sys >= 130 || dia >= 80) return BP_COLOR_MAP.STAGE_1;
    if (sys >= 120 && dia < 80) return BP_COLOR_MAP.ELEVATED;
    return BP_COLOR_MAP.NORMAL;
}

function getPulseColorClass(pulse) {
    return pulse < 40 || pulse > 100 ? "text-red-700 font-bold" : "text-green-700";
}

function formatDateThai(dateStr) {
    return new Date(dateStr).toLocaleDateString("th-TH", {
        year: "numeric", month: "short", day: "numeric"
    });
}

function toDateString(date) {
    return date.toISOString().split("T")[0];
}

/* ======================================================
   3) RENDER FUNCTIONS
====================================================== */

function updateDashboard(startDateStr, endDateStr) {
    const start = startDateStr ? new Date(startDateStr) : new Date("2000-01-01");
    const end = endDateStr ? new Date(endDateStr + "T23:59") : new Date();

    filteredBpRecords = allBpRecords.filter(r => {
        const d = new Date(r.date);
        return d >= start && d <= end;
    });

    renderAverages();
    renderChart();
    renderTable();
}

function renderAverages() {
    const container = document.getElementById("average-bento");

    if (filteredBpRecords.length === 0) {
        container.innerHTML =
            `<div class="col-span-full p-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
    }

    const calc = (arr, key) => ({
        avg: (arr.reduce((a, b) => a + b[key], 0) / arr.length).toFixed(0),
        min: Math.min(...arr.map(a => a[key])),
        max: Math.max(...arr.map(a => a[key]))
    });

    const sys = calc(filteredBpRecords, "systolic");
    const dia = calc(filteredBpRecords, "diastolic");
    const pulse = calc(filteredBpRecords, "pulse");

    const items = [
        { title: "‡∏ï‡∏±‡∏ß‡∏ö‡∏ô", value: sys.avg, unit: "‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó", range: `${sys.min}-${sys.max}`, color: "text-red-600", bg: "bg-red-50" },
        { title: "‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á", value: dia.avg, unit: "‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó", range: `${dia.min}-${dia.max}`, color: "text-blue-600", bg: "bg-blue-50" },
        { title: "‡∏ä‡∏µ‡∏û‡∏à‡∏£", value: pulse.avg, unit: "‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ", range: `${pulse.min}-${pulse.max}`, color: "text-green-600", bg: "bg-green-50" },
        { title: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á", value: filteredBpRecords.length, unit: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", range: "", color: "text-yellow-600", bg: "bg-yellow-50" }
    ];

    container.innerHTML = items.map(card => `
        <div class="bento-card p-6 ${card.bg}">
            <p class="text-sm text-gray-500">${card.title}</p>
            <p class="text-3xl font-bold ${card.color}">${card.value}</p>
            <p class="text-xs text-gray-500">${card.unit}</p>
            <p class="text-xs text-gray-600 mt-2">${card.range}</p>
        </div>
    `).join("");
}

function renderChart() {
    const ctx = document.getElementById("bpLineChart").getContext("2d");

    if (bpChartInstance) bpChartInstance.destroy();

    if (filteredBpRecords.length === 0) {
        bpChartInstance = new Chart(ctx, {
            type: "line",
            data: { labels: [], datasets: [] }
        });
        return;
    }

    const grouped = {};
    filteredBpRecords.forEach(r => {
        if (!grouped[r.date]) grouped[r.date] = [];
        grouped[r.date].push(r);
    });

    const labels = Object.keys(grouped).map(formatDateThai);

    function avg(key, arr) {
        return (arr.reduce((a, b) => a + b[key], 0) / arr.length).toFixed(0);
    }

    const sysData = Object.values(grouped).map(a => avg("systolic", a));
    const diaData = Object.values(grouped).map(a => avg("diastolic", a));
    const pulseData = Object.values(grouped).map(a => avg("pulse", a));

    bpChartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [
                { label: "‡∏ï‡∏±‡∏ß‡∏ö‡∏ô", data: sysData, borderColor: "#ef4444" },
                { label: "‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á", data: diaData, borderColor: "#3b82f6" },
                { label: "‡∏ä‡∏µ‡∏û‡∏à‡∏£", data: pulseData, borderColor: "#10b981" }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function renderTable() {
    const tbody = document.getElementById("bp-table-body");

    if (filteredBpRecords.length === 0) {
        tbody.innerHTML =
            `<tr><td colspan="5" class="text-center py-6 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
    }

    tbody.innerHTML = filteredBpRecords.map(r => {
        const col = getBpCategory(r.systolic, r.diastolic).tailwind;

        return `
            <tr class="hover:bg-gray-100">
                <td>${formatDateThai(r.date)}</td>
                <td>${r.period ?? r.time ?? "-"}</td>
                <td class="${col} font-bold">${r.systolic}</td>
                <td class="${col} font-bold">${r.diastolic}</td>
                <td class="${getPulseColorClass(r.pulse)}">${r.pulse}</td>
            </tr>
        `;
    }).join("");
}

/* ======================================================
   4) FILTER AND INIT
====================================================== */

function setupFilters() {
    const startInput = document.getElementById("startDate");
    const endInput = document.getElementById("endDate");

    const buttons = document.querySelectorAll(".quick-filter-btn");

    function apply(type) {
        const now = new Date();
        let start;

        if (type === "this-month") start = new Date(now.getFullYear(), now.getMonth(), 1);
        else if (type === "last-3-months") start = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
        else if (type === "this-year") start = new Date(now.getFullYear(), 0, 1);
        else start = new Date("2000-01-01");

        startInput.value = type === "all-time" ? "" : toDateString(start);
        endInput.value = toDateString(now);

        updateDashboard(startInput.value, endInput.value);
    }

    buttons.forEach(btn => {
        btn.onclick = () => apply(btn.dataset.filter);
    });

    document.getElementById("print-button").onclick = () => window.print();

    apply("all-time");
}

window.onload = async () => {
    await loadBpData();   // Load real DB data
    setupFilters();       // Render dashboard
};

</script>

</body>
</html>
