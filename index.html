<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏à üê† (Dev Mode)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for a cleaner font and layout */
        :root {
            font-family: 'Inter', sans-serif;
        }
        .bento-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
            border: 1px solid #e5e7eb;
        }
        .bento-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            height: 350px; /* Fixed height for chart area */
        }
        /* Style the table for better aesthetics */
        .record-table th, .record-table td {
            padding: 12px 16px;
            text-align: left;
        }
        .record-table th {
            background-color: #f3f4f6;
            color: #1f2937;
            font-weight: 600;
        }
        .record-table tbody tr:nth-child(odd) {
            background-color: #f9fafb;
        }
        .quick-filter-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* --- Print Styles to hide controls for PDF/Print output --- */
        @media print {
            .no-print {
                display: none !important;
            }
            .bento-card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
            .max-w-6xl {
                max-width: 100%;
                margin: 0;
            }
            .chart-container {
                height: 450px; /* Make chart larger for print */
            }
            /* Ensure table header is visible on every page */
            .record-table thead {
                display: table-header-group;
            }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-8 text-center">
            ‡∏™‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏à üê†
        </h1>
        
        <!-- Filter Controls (Marked as no-print to hide when printing) -->
        <div class="bento-card p-6 md:p-8 mb-6 no-print">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
            <div class="flex flex-col lg:flex-row lg:items-end gap-4">
                <!-- Date Range Inputs -->
                <div class="flex-grow flex flex-col sm:flex-row gap-4">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
                        <input type="date" id="startDate" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm p-1.5 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                        <input type="date" id="endDate" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm p-1.5 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="flex flex-wrap gap-2 lg:ml-4 flex-grow-0">
                    <button data-filter="this-month" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-gray-300 bg-white hover:bg-gray-100 transition">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <button data-filter="last-3-months" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-gray-300 bg-white hover:bg-gray-100 transition">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</button>
                    <button data-filter="this-year" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-gray-300 bg-white hover:bg-gray-100 transition">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
                    <button data-filter="all-time" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-gray-300 active bg-blue-500 text-white hover:bg-blue-600 transition">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô</button>
                </div>
            </div>
            
            <!-- Print Button -->
            <div class="mt-4 flex justify-end">
                <button id="print-button" class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white hover:bg-indigo-700 transition flex items-center justify-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5 4v3h10V4a2 2 0 00-2-2H7a2 2 0 00-2 2zM3 10v6a2 2 0 002 2h10a2 2 0 002-2v-6H3zm6 0a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    ‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF
                </button>
            </div>
        </div>

        <!-- 1. Bento Box for Averages (‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢) -->
        <!-- Responsive grid for 4 cards -->
        <div id="average-bento" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <!-- Data will be inserted here by JavaScript -->
        </div>

        <!-- 2. Line Chart of Records vs Date -->
        <div class="bento-card p-6 md:p-8 mb-10">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ä‡∏µ‡∏û‡∏à‡∏£</h2>
            <div class="chart-container">
                <canvas id="bpLineChart"></canvas>
            </div>
        </div>

        <!-- 3. Beautiful Detailed Table -->
        <div class="bento-card p-4 sm:p-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
            <div class="overflow-x-auto">
                <table class="w-full record-table border-collapse text-sm">
                    <thead>
                        <tr class="border-b">
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (Systolic)</th>
                            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (Diastolic)</th>
                            <th>‡∏ä‡∏µ‡∏û‡∏à‡∏£ (Pulse)</th>
                        </tr>
                    </thead>
                    <tbody id="bp-table-body">
                        <!-- Table rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Placeholder Data (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
        // Mock data covering a period for filtering and showing different categories
        const allBpRecords = [
            { date: '2025-08-15', time: '‡πÄ‡∏ä‡πâ‡∏≤', systolic: 120, diastolic: 78, pulse: 70 }, // Elevated BP
            { date: '2025-09-01', time: '‡πÄ‡∏¢‡πá‡∏ô', systolic: 135, diastolic: 85, pulse: 78 }, // Stage 1
            { date: '2025-09-10', time: '‡πÄ‡∏ä‡πâ‡∏≤', systolic: 155, diastolic: 95, pulse: 72 }, // Stage 2
            { date: '2025-10-05', time: '‡πÄ‡∏¢‡πá‡∏ô', systolic: 110, diastolic: 70, pulse: 110 }, // High Pulse
            { date: '2025-10-15', time: '‡πÄ‡∏ä‡πâ‡∏≤', systolic: 190, diastolic: 130, pulse: 68 }, // Crisis
            { date: '2025-11-01', time: '‡πÄ‡∏¢‡πá‡∏ô', systolic: 120, diastolic: 79, pulse: 70 }, // Elevated BP
            { date: '2025-11-10', time: '‡πÄ‡∏ä‡πâ‡∏≤', systolic: 135, diastolic: 90, pulse: 85 }, // Stage 2 (Diastolic triggered)
            { date: '2025-12-02', time: '‡πÄ‡∏¢‡πá‡∏ô', systolic: 115, diastolic: 75, pulse: 35 }, // Low Pulse
            { date: '2025-12-03', time: '‡πÄ‡∏ä‡πâ‡∏≤', systolic: 118, diastolic: 78, pulse: 75 }, // Normal
            { date: '2025-12-03', time: '‡πÄ‡∏¢‡πá‡∏ô', systolic: 119, diastolic: 79, pulse: 78 }, // Normal
            { date: '2025-12-04', time: '‡πÄ‡∏¢‡πá‡∏ô', systolic: 150, diastolic: 95, pulse: 88 },       
        ];
        
        let filteredBpRecords = []; // Global variable to store currently filtered data
        let bpChartInstance = null; // Global variable for Chart.js instance

        // --- BP Classification Logic ---
        const BP_COLOR_MAP = {
            // point: Background color for chart point fill, border: Border color for chart point, tailwind: text class for table
            NORMAL: { hex: '#059669', tailwind: 'text-green-700', point: 'rgba(5, 150, 105, 0.1)', border: '#059669' }, 
            ELEVATED: { hex: '#facc15', tailwind: 'text-yellow-700', point: '#facc15', border: '#facc15' }, 
            STAGE_1: { hex: '#f97316', tailwind: 'text-orange-700', point: '#f97316', border: '#f97316' }, 
            STAGE_2: { hex: '#ea580c', tailwind: 'text-red-600', point: '#ea580c', border: '#ea580c' }, 
            CRISIS: { hex: '#dc2626', tailwind: 'text-red-800', point: '#dc2626', border: '#dc2626' } 
        };
        
        const getBpCategory = (sys, dia) => {
            // 1. Hypertensive Crisis (>180 and/or >120) - Mapped to user's 'red' / Stage 3
            if (sys > 180 || dia > 120) return BP_COLOR_MAP.CRISIS;
            // 2. Stage 2 Hypertension (>=140 or >=90) - Mapped to user's 'dark orange'
            if (sys >= 140 || dia >= 90) return BP_COLOR_MAP.STAGE_2;
            // 3. Stage 1 Hypertension (130-139 or 80-89) - Mapped to user's 'orange'
            if (sys >= 130 || dia >= 80) return BP_COLOR_MAP.STAGE_1;
            // 4. Elevated (120-129 and <80) - Mapped to user's 'yellow'
            if (sys >= 120 && dia < 80) return BP_COLOR_MAP.ELEVATED;
            // 5. Normal (<120 and <80) - Mapped to user's 'transparent' / light green
            if (sys < 120 && dia < 80) return BP_COLOR_MAP.NORMAL;
            
            // Default for edge cases (e.g., sys=110, dia=95) should fall into Stage 2
            // The prioritized check above handles this correctly. If none matched, default to Normal.
            return BP_COLOR_MAP.NORMAL; 
        };

        const getPulseColorClass = (pulse) => {
            // Pulse Normal Range: 40-100. Exceed (Low/High) make red.
            if (pulse < 40 || pulse > 100) {
                return 'text-red-700 font-bold';
            }
            return 'text-green-700'; // Normal
        };


        // Function to format date to Thai (short month name)
        const formatDateThai = (dateString) => {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            // Use 'th-TH' locale for Thai formatting
            return date.toLocaleDateString('th-TH', options);
        };
        
        // Utility for converting Date object to date string (YYYY-MM-DD)
        const toDateString = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Function to calculate start/end dates for quick filters
        const getFilterDates = (filterType) => {
            const now = new Date();
            // Set time to end of day for 'end' date to include today's records
            now.setHours(23, 59, 59, 999); 
            let startDate; 
            const endDate = now;

            if (filterType === 'this-month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (filterType === 'last-3-months') {
                // Go back 3 full months from today's date
                startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
            } else if (filterType === 'this-year') {
                startDate = new Date(now.getFullYear(), 0, 1);
            } else if (filterType === 'all-time') {
                // Date far in the past
                startDate = new Date('2000-01-01'); 
            } else {
                startDate = new Date('2000-01-01');
            }
            
            // Set time to start of day for 'start' date
            startDate.setHours(0, 0, 0, 0);

            return { 
                start: toDateString(startDate), 
                end: toDateString(endDate) 
            };
        };

        // Main function to filter records and update the UI
        const updateDashboard = (startDateStr, endDateStr) => {
            const start = startDateStr ? new Date(startDateStr) : new Date('2000-01-01');
            // Add a day to the end date to ensure it includes records on that date
            const end = endDateStr ? new Date(new Date(endDateStr).setHours(23, 59, 59, 999)) : new Date();

            // Filter the global records
            filteredBpRecords = allBpRecords.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= start && recordDate <= end;
            });

            // Re-render all sections with the new filtered data
            renderAverages();
            renderChart();
            renderTable();
        };

        // --- 1. Render Averages Bento Box (including min/max and count) ---
        const renderAverages = () => {
            const container = document.getElementById('average-bento');
            if (!container) return;

            if (filteredBpRecords.length === 0) {
                 // Handle empty state gracefully
                 container.innerHTML = `<div class="col-span-full p-8 text-center text-gray-500">
                     ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                 </div>`;
                 return;
            }

            // Calculate Averages, Min, Max
            const initialMinMax = { min: Infinity, max: -Infinity, sum: 0 };
            const totals = filteredBpRecords.reduce((acc, record) => {
                acc.systolic.sum += record.systolic;
                acc.diastolic.sum += record.diastolic;
                acc.pulse.sum += record.pulse;

                acc.systolic.min = Math.min(acc.systolic.min, record.systolic);
                acc.systolic.max = Math.max(acc.systolic.max, record.systolic);
                
                acc.diastolic.min = Math.min(acc.diastolic.min, record.diastolic);
                acc.diastolic.max = Math.max(acc.diastolic.max, record.diastolic);
                
                acc.pulse.min = Math.min(acc.pulse.min, record.pulse);
                acc.pulse.max = Math.max(acc.pulse.max, record.pulse);
                
                return acc;
            }, { 
                systolic: {...initialMinMax}, 
                diastolic: {...initialMinMax}, 
                pulse: {...initialMinMax} 
            });

            const count = filteredBpRecords.length;
            const averages = {
                systolic: (totals.systolic.sum / count).toFixed(0),
                diastolic: (totals.diastolic.sum / count).toFixed(0),
                pulse: (totals.pulse.sum / count).toFixed(0)
            };

            const dataCards = [
                {
                    title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (Systolic)',
                    value: averages.systolic,
                    unit: '‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó',
                    range: `${totals.systolic.min}-${totals.systolic.max}`,
                    color: 'text-red-600',
                    icon: 'M9 19V6l2.5-2.5L14 6v13', // Mock Icon for BP
                    bgColor: 'bg-red-50'
                },
                {
                    title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (Diastolic)',
                    value: averages.diastolic,
                    unit: '‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó',
                    range: `${totals.diastolic.min}-${totals.diastolic.max}`,
                    color: 'text-blue-600',
                    icon: 'M9 19V6l2.5-2.5L14 6v13', // Mock Icon for BP
                    bgColor: 'bg-blue-50'
                },
                {
                    title: '‡∏ä‡∏µ‡∏û‡∏à‡∏£ (Pulse)',
                    value: averages.pulse,
                    unit: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ',
                    range: `${totals.pulse.min}-${totals.pulse.max}`,
                    color: 'text-green-600',
                    icon: 'M4.32 10.68a2.5 2.5 0 010-3.36l2.91-2.91a2.5 2.5 0 013.36 0L15 7.64a2.5 2.5 0 010 3.36l-2.91 2.91a2.5 2.5 0 01-3.36 0z', // Heart beat icon
                    bgColor: 'bg-green-50'
                },
                {
                    title: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î',
                    value: count,
                    unit: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    range: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á',
                    color: 'text-yellow-600',
                    icon: 'M12 4.354c.482-.132 1.01-.132 1.492 0L21 8.5v7l-7.508 4.146c-.482.132-1.01.132-1.492 0L3 15.5v-7l7.508-4.146z', // Box/Record Icon
                    bgColor: 'bg-yellow-50'
                }
            ];

            container.innerHTML = dataCards.map(card => `
                <div class="bento-card p-6 ${card.bgColor} flex flex-col justify-between">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-500">${card.title}</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${card.color}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="${card.icon}" />
                        </svg>
                    </div>
                    <div class="mb-4">
                        <p class="text-3xl font-bold ${card.color}">${card.value}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${card.unit}</p>
                    </div>
                    <!-- Min/Max or Range -->
                    <div class="pt-2 border-t border-gray-200">
                        <p class="text-xs font-semibold text-gray-600">
                            <span class="text-gray-400">‡∏ä‡πà‡∏ß‡∏á:</span> ${card.range}
                        </p>
                    </div>
                </div>
            `).join('');
        };

        // --- 2. Render Line Chart (using filtered data and point coloring) ---
        const renderChart = () => {
            const ctx = document.getElementById('bpLineChart').getContext('2d');

            // Destroy existing chart instance if it exists
            if (bpChartInstance) {
                bpChartInstance.destroy();
            }

            if (filteredBpRecords.length === 0) {
                // Render a placeholder when no data
                bpChartInstance = new Chart(ctx, {
                     type: 'line',
                     data: { labels: [''], datasets: [] },
                     options: { 
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
                                font: { size: 18, family: 'Inter, sans-serif' }
                            },
                            legend: { display: false }
                        },
                        scales: { x: { display: false }, y: { display: false } }
                     }
                });
                return;
            }

            // Group data by unique date and calculate average for that date
            const dataByDate = filteredBpRecords.reduce((acc, record) => {
                const key = record.date;
                if (!acc[key]) {
                    acc[key] = { systolic: [], diastolic: [], pulse: [] };
                }
                acc[key].systolic.push(record.systolic);
                acc[key].diastolic.push(record.diastolic);
                acc[key].pulse.push(record.pulse);
                return acc;
            }, {});

            const chartLabels = Object.keys(dataByDate).map(formatDateThai);
            
            const getAverageDataAndColors = (key) => {
                const data = [];
                const pointColors = [];
                const pointBorders = [];

                Object.values(dataByDate).forEach(dailyData => {
                    const avgSys = dailyData.systolic.reduce((a, b) => a + b, 0) / dailyData.systolic.length;
                    const avgDia = dailyData.diastolic.reduce((a, b) => a + b, 0) / dailyData.diastolic.length;
                    const avgPulse = dailyData.pulse.reduce((a, b) => a + b, 0) / dailyData.pulse.length;

                    // Data point is the average of the specific key (sys, dia, or pulse)
                    let avgValue;
                    let classificationColor;
                    
                    if (key === 'systolic' || key === 'diastolic') {
                        avgValue = (key === 'systolic' ? avgSys : avgDia);
                        // Classify the daily average reading
                        classificationColor = getBpCategory(avgSys, avgDia);
                        pointColors.push(classificationColor.point);
                        pointBorders.push(classificationColor.border);
                    } else if (key === 'pulse') {
                        avgValue = avgPulse;
                        // Determine point color based on pulse health
                        const pulseClass = getPulseColorClass(avgPulse);
                        if (pulseClass.includes('red')) {
                            pointColors.push(BP_COLOR_MAP.CRISIS.point); // Use red for abnormal pulse point
                            pointBorders.push(BP_COLOR_MAP.CRISIS.border);
                        } else {
                            pointColors.push(BP_COLOR_MAP.NORMAL.point); // Use green for normal pulse point
                            pointBorders.push(BP_COLOR_MAP.NORMAL.border);
                        }
                    }
                    data.push(avgValue.toFixed(0));
                });
                return { data, pointColors, pointBorders };
            };

            const systolicResults = getAverageDataAndColors('systolic');
            const diastolicResults = getAverageDataAndColors('diastolic');
            const pulseResults = getAverageDataAndColors('pulse');
            
            // Collect all data points for Y-axis scaling
            const allChartValues = systolicResults.data.concat(diastolicResults.data, pulseResults.data).map(Number);
            const minY = Math.min(...allChartValues) * 0.95;
            const maxY = Math.max(...allChartValues) * 1.05;


            bpChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (Avg)',
                            data: systolicResults.data,
                            borderColor: '#ef4444', // Red Line
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            pointBackgroundColor: systolicResults.pointColors, // Color points by category
                            pointBorderColor: systolicResults.pointBorders,
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (Avg)',
                            data: diastolicResults.data,
                            borderColor: '#3b82f6', // Blue Line
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            pointBackgroundColor: diastolicResults.pointColors, // Color points by category
                            pointBorderColor: diastolicResults.pointBorders,
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: '‡∏ä‡∏µ‡∏û‡∏à‡∏£ (Avg)',
                            data: pulseResults.data,
                            borderColor: '#10b981', // Green Line
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            pointBackgroundColor: pulseResults.pointColors, // Color points by pulse health
                            pointBorderColor: pulseResults.pointBorders,
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            tension: 0.3,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // ... (rest of chart options)
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô/‡∏ä‡∏µ‡∏û‡∏à‡∏£ (‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)',
                                font: {
                                    family: 'Inter, sans-serif'
                                }
                            },
                            min: minY > 0 ? minY : 0, // Ensure min is not negative
                            max: maxY
                        },
                        x: {
                            title: {
                                display: true,
                                text: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                                font: {
                                    family: 'Inter, sans-serif'
                                }
                            }
                        }
                    }
                }
            });
        };

        // --- 3. Render Detailed Table (using filtered data and cell coloring) ---
        const renderTable = () => {
            const tbody = document.getElementById('bp-table-body');
            if (!tbody) return;
            
            if (filteredBpRecords.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
                return;
            }

            const html = filteredBpRecords.map(record => {
                const bpCategory = getBpCategory(record.systolic, record.diastolic);
                const pulseClass = getPulseColorClass(record.pulse);
                
                // Use the category's tailwind class for both S and D for consistency
                const bpClass = bpCategory.tailwind + ' font-bold'; 

                return `
                    <tr class="hover:bg-gray-100 transition-colors duration-150">
                        <td>${formatDateThai(record.date)}</td>
                        <td>${record.time}</td>
                        <td class="${bpClass}">${record.systolic}</td>
                        <td class="${bpClass}">${record.diastolic}</td>
                        <td class="${pulseClass}">${record.pulse}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        };
        
        // --- 4. Filter Setup and Event Listeners (Including Print) ---
        const setupFilters = () => {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const filterButtons = document.querySelectorAll('.quick-filter-btn');
            const printButton = document.getElementById('print-button');

            // Set initial filter to "All Time"
            const initialDates = getFilterDates('all-time');
            updateDashboard(initialDates.start, initialDates.end);
            
            // Function to set button active state
            const setActiveButton = (targetButton) => {
                filterButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-500', 'text-white', 'hover:bg-blue-600');
                    btn.classList.add('bg-white', 'hover:bg-gray-100');
                });
                if (targetButton) {
                    targetButton.classList.add('active', 'bg-blue-500', 'text-white', 'hover:bg-blue-600');
                    targetButton.classList.remove('bg-white', 'hover:bg-gray-100');
                }
            };

            // Event listener for date range changes
            const handleDateChange = () => {
                // Clear quick filter active state when manual dates are set
                setActiveButton(null);
                updateDashboard(startDateInput.value, endDateInput.value);
            };
            startDateInput.addEventListener('change', handleDateChange);
            endDateInput.addEventListener('change', handleDateChange);

            // Event listener for quick filters
            filterButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const filterType = e.currentTarget.getAttribute('data-filter');
                    const { start, end } = getFilterDates(filterType);
                    
                    // Set inputs to reflect the quick filter dates (if they are within reasonable range)
                    startDateInput.value = start === toDateString(new Date('2000-01-01')) ? '' : start;
                    endDateInput.value = end;
                    
                    updateDashboard(start, end);
                    setActiveButton(e.currentTarget);
                });
            });
            
            // Event listener for Print Button (Wrapped in try/catch for environment safety)
            if (printButton) {
                printButton.addEventListener('click', () => {
                    try {
                        console.log("Attempting to open print dialog...");
                        window.print();
                        console.log("Print dialog should be visible.");
                    } catch (error) {
                        console.error("Error triggering print dialog (may be restricted by environment/iframe):", error);
                        // Optional: Show a user-friendly message if possible, though not using alert/confirm
                    }
                });
            }


            // Set initial active state for "All Time"
            setActiveButton(document.querySelector('[data-filter="all-time"]'));
        };

        // Initial setup on window load
        window.onload = () => {
            setupFilters();
        };

    </script>
</body>
</html>}